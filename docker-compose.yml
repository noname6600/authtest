version: "3.9"

services:
  # === Frontend Builder ===
  frontend-builder:
    build: ./frontend
    container_name: frontend-builder
    volumes:
      - frontend-dist:/frontend-dist
    networks:
      - auth-net
    restart: "no"

  # === Frontend (SPA) ===
  frontend:
    build:
      context: ./frontend
    container_name: auth-frontend
    expose:
      - "80"
    networks:
      - auth-net
    restart: unless-stopped

  # === Nginx: Serve SPA + Reverse Proxy ===
  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "80:80"
    volumes:
      - frontend-dist:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - frontend-builder
      - api-gateway
      - eureka-server
    networks:
      - auth-net
    restart: unless-stopped

  # ============================================
  # === Backend Basic Auth ===
  # ============================================
  backend-basic:
    build:
      context: ./backend-basic
    container_name: auth-backend-basic
    expose:
      - "8082"
    networks:
      - auth-net
    restart: unless-stopped
    environment:
      PORT: 8082
      MASTER_DATABASE_URL: jdbc:mysql://mysql:3306/auth
      MASTER_DATABASE_USER: root
      MASTER_DATABASE_PWD: 123456
      CORS_ORIGINS: "http://basicauth.nani.id.vn"
      CORS_METHODS: "GET,POST,PUT,DELETE,OPTIONS"
      RESET_LINK: "http://basicauth.nani.id.vn"
      MAIL_HOST: smtp.gmail.com
      MAIL_PORT: 587
      MAIL_USERNAME: chieng6600@gmail.com
      MAIL_PASSWORD: krpkjexzucnqmyep
      MAIL_SMTP_AUTH: "true"
      MAIL_SMTP_STARTTLS_ENABLE: "true"

  # ============================================
  # === Auth-Service ===
  # ============================================
  auth-service:
    build:
      context: ./auth-service
    container_name: auth-service
    expose:
      - "8081"
    networks:
      - auth-net
    restart: unless-stopped
    environment:
      PORT: 8081
      MASTER_DATABASE_URL: jdbc:mysql://mysql:3306/auth
      MASTER_DATABASE_USER: root
      MASTER_DATABASE_PWD: 123456
      EUREKA_URL: http://eureka-server:8761/eureka
      MAIL_HOST: smtp.gmail.com
      MAIL_PORT: 587
      MAIL_USER: chieng6600@gmail.com
      MAIL_PASSWORD: krpkjexzucnqmyep
      RESET_LINK: http://basicauth.nani.id.vn
      KEY_ROTATION_MS: 120000
      JWT_EXPIRATION_MS: 180000

  # ============================================
  # === Order-Service ===
  # ============================================
  order-service:
    build:
      context: ./order-service
    container_name: order-service
    expose:
      - "8083"
    networks:
      - auth-net
    restart: unless-stopped
    environment:
      SERVER_PORT: 8083
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/auth
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 123456
      EUREKA_URL: http://eureka-server:8761/eureka

  # ============================================
  # === API Gateway ===
  # ============================================
  api-gateway:
    build:
      context: ./api-gateway
    container_name: api-gateway
    expose:
      - "8080"
    networks:
      - auth-net
    restart: unless-stopped
    depends_on:
      - eureka-server
      - auth-service
      - order-service
    environment:
      PORT: 8080
      EUREKA_URL: http://eureka-server:8761/eureka
      CORS_ALLOWED_ORIGINS: http://authbasic.nani.id.vn

  # ============================================
  # === Eureka Server ===
  # ============================================
  eureka-server:
    build:
      context: ./eureka-server
    container_name: eureka-server
    expose:
      - "8761"
    networks:
      - auth-net
    restart: unless-stopped
    environment:
      SERVER_PORT: 8761

  # === MySQL ===
  mysql:
    image: mysql:8
    container_name: auth-mysql
    environment:
      MYSQL_ROOT_PASSWORD: "123456"
      MYSQL_DATABASE: auth
      MYSQL_USER: root
      MYSQL_PASSWORD: 123456
      MYSQL_ROOT_HOST: "%"
    volumes:
      - auth-mysql:/var/lib/mysql
    networks:
      - auth-net
    restart: unless-stopped

# === Networks ===
networks:
  auth-net:

# === Volumes ===
volumes:
  auth-mysql:
  frontend-dist:
